<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜å“è³ªå½±ç‰‡ç•«é¢æˆªå–å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .quality-badge {
            display: inline-block;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 8px 18px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 700;
            margin-left: 15px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }
            to {
                box-shadow: 0 6px 25px rgba(255, 107, 107, 0.7);
            }
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px dashed #667eea;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .file-input-wrapper {
            text-align: center;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1.1em;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .setting-group {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .setting-group input, .setting-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .setting-group input:focus, .setting-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .quality-info {
            background: #e8f5e8;
            border: 1px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .quality-info h4 {
            color: #155724;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quality-features {
            list-style: none;
            color: #155724;
        }

        .quality-features li {
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .video-container {
            text-align: center;
            margin: 30px 0;
            position: relative;
            display: inline-block;
        }

        video {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            display: block;
        }

        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
        }

        .crop-frame {
            position: absolute;
            border: 3px solid #ff6b6b;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            cursor: move;
            pointer-events: all;
        }

        .crop-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff6b6b;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: all;
        }

        .crop-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .crop-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .crop-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .crop-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }

        .crop-info {
            position: absolute;
            top: -35px;
            left: 0;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            white-space: nowrap;
        }

        .crop-controls {
            margin-top: 15px;
            display: none;
        }

        .crop-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin: 0 5px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .crop-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .crop-button.active {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .video-info {
            margin-top: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: left;
            display: none;
        }

        .extract-button {
            display: block;
            width: 200px;
            margin: 30px auto;
            padding: 15px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .extract-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .extract-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-container {
            display: none;
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            color: #495057;
        }

        .output-section {
            margin-top: 40px;
        }

        .output-stats {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .output-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .output-item {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .output-item:hover {
            transform: translateY(-4px);
        }

        .output-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .frame-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .download-link {
            display: block;
            text-align: center;
            padding: 8px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .download-link:hover {
            background: #5a6fd8;
        }

        .download-all {
            text-align: center;
            margin: 30px 0;
        }

        .download-all-button {
            padding: 12px 25px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .download-all-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
        }

        .info-text {
            color: #6c757d;
            font-size: 0.9em;
            text-align: center;
            margin-top: 10px;
        }

        .advanced-toggle {
            text-align: center;
            margin: 20px 0;
        }

        .toggle-button {
            background: none;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .toggle-button:hover {
            background: #667eea;
            color: white;
        }

        .advanced-settings {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ é«˜å“è³ªå½±ç‰‡ç•«é¢æˆªå–å·¥å…·<span class="quality-badge">ğŸ”¥ Ultra HD</span></h1>
        
        <div class="upload-section">
            <div class="file-input-wrapper">
                <label for="videoFile" class="file-input-label">
                    ğŸ“ é¸æ“‡å½±ç‰‡æª”æ¡ˆ
                </label>
                <input type="file" id="videoFile" class="file-input" accept="video/*">
            </div>
            <div class="info-text">æ”¯æ´ MP4ã€MOVã€AVIã€WebM ç­‰æ ¼å¼ | è‡ªå‹•å„ªåŒ–æœ€é«˜å“è³ªè¼¸å‡º</div>
        </div>

        <div class="settings">
            <div class="setting-group">
                <label for="interval">æˆªå–é–“éš” (ç§’)</label>
                <input type="number" id="interval" value="1" min="0.1" step="0.1">
                <div class="info-text">ç²¾ç¢ºåˆ° 0.1 ç§’çš„æ™‚é–“æ§åˆ¶</div>
            </div>
            
            <div class="setting-group">
                <label for="quality">åœ–ç‰‡å“è³ª</label>
                <select id="quality">
                    <option value="1.0">ğŸ”¥ å®Œç¾å“è³ª (100% - ç„¡æ)</option>
                    <option value="0.98">ğŸ’ æ¥µé«˜å“è³ª (98%)</option>
                    <option value="0.95" selected>â­ è¶…é«˜å“è³ª (95%)</option>
                    <option value="0.9">ğŸ¯ é«˜å“è³ª (90%)</option>
                    <option value="0.8">ğŸ“· æ¨™æº–å“è³ª (80%)</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label for="format">è¼¸å‡ºæ ¼å¼</label>
                <select id="format">
                    <option value="image/png" selected>ğŸ”¥ PNG (ç„¡æå£“ç¸®)</option>
                    <option value="image/webp">âš¡ WebP (å…ˆé€²å£“ç¸®)</option>
                    <option value="image/jpeg">ğŸ“· JPEG (é€šç”¨æ ¼å¼)</option>
                </select>
            </div>

            <div class="setting-group">
                <label for="smoothing">å½±åƒå¹³æ»‘åŒ–</label>
                <select id="smoothing">
                    <option value="false" selected>ğŸ”¥ é—œé–‰ (æœ€éŠ³åˆ©)</option>
                    <option value="true">é–‹å•Ÿ (å¹³æ»‘è™•ç†)</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label for="cropMode">ğŸ“ æ¡†æ¶æˆªå–æ¨¡å¼</label>
                <select id="cropMode">
                    <option value="full" selected>ğŸ–¼ï¸ å®Œæ•´ç•«é¢</option>
                    <option value="crop">âœ‚ï¸ è‡ªè¨‚æ¡†æ¶å€åŸŸ</option>
                </select>
                <div class="info-text">é–‹å•Ÿå¾Œå¯æ‹–æ‹‰é¸æ“‡æˆªå–å€åŸŸ</div>
            </div>
        </div>

        <div class="advanced-toggle">
            <button class="toggle-button" onclick="toggleAdvanced()">âš™ï¸ é€²éšè¨­å®š</button>
        </div>

        <div class="advanced-settings" id="advancedSettings">
            <div class="settings">
                <div class="setting-group">
                    <label for="sharpening">éŠ³åŒ–å¼·åº¦</label>
                    <input type="range" id="sharpening" min="0" max="2" step="0.1" value="0">
                    <div class="info-text">0 = é—œé–‰, 2 = æœ€å¼·éŠ³åŒ–</div>
                </div>
                
                <div class="setting-group">
                    <label for="contrast">å°æ¯”åº¦èª¿æ•´</label>
                    <input type="range" id="contrast" min="0.5" max="2" step="0.1" value="1">
                    <div class="info-text">1 = åŸå§‹, >1 = å¢å¼·å°æ¯”</div>
                </div>
                
                <div class="setting-group">
                    <label for="saturation">é£½å’Œåº¦èª¿æ•´</label>
                    <input type="range" id="saturation" min="0" max="2" step="0.1" value="1">
                    <div class="info-text">1 = åŸå§‹, >1 = æ›´é®®è±”</div>
                </div>
            </div>
        </div>

        <div class="quality-info">
            <h4>ğŸ”¥ é«˜å“è³ªå„ªåŒ–åŠŸèƒ½</h4>
            <ul class="quality-features">
                <li>âœ… åŸå§‹è§£æåº¦ä¿æŒ - 0% å“è³ªæå¤±</li>
                <li>âœ… ç²¾ç¢ºå¹€å®šä½ - æ¯«ç§’ç´šæº–ç¢ºåº¦</li>
                <li>âœ… é€²éšå½±åƒè™•ç† - éŠ³åŒ–èˆ‡è‰²å½©å¢å¼·</li>
                <li>âœ… å¤šç¨®ç„¡ææ ¼å¼ - PNG, WebP æ”¯æ´</li>
                <li>âœ… ç¡¬é«”åŠ é€Ÿæ¸²æŸ“ - æœ€å¿«è™•ç†é€Ÿåº¦</li>
                <li>âœ… æ‰¹é‡è™•ç†å„ªåŒ– - ä¸€æ¬¡è™•ç†å¤šå¹€</li>
            </ul>
        </div>

        <div class="video-container" id="videoContainer" style="display: none;">
            <video id="videoPreview" controls></video>
            <div class="crop-overlay" id="cropOverlay">
                <div class="crop-frame" id="cropFrame">
                    <div class="crop-info" id="cropInfo">800 Ã— 600</div>
                    <div class="crop-handle nw"></div>
                    <div class="crop-handle ne"></div>
                    <div class="crop-handle sw"></div>
                    <div class="crop-handle se"></div>
                </div>
            </div>
            <div class="crop-controls" id="cropControls">
                <button class="crop-button" onclick="resetCropFrame()">ğŸ”„ é‡ç½®æ¡†æ¶</button>
                <button class="crop-button" onclick="centerCropFrame()">ğŸ¯ ç½®ä¸­æ¡†æ¶</button>
                <button class="crop-button" onclick="toggleCropPreview()">ğŸ‘ï¸ é è¦½æˆªå–</button>
            </div>
            <div class="video-info" id="videoInfo"></div>
        </div>

        <button id="extractButton" class="extract-button" disabled>
            ğŸ¯ é–‹å§‹é«˜å“è³ªæˆªå–
        </button>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">æº–å‚™ä¸­...</div>
        </div>

        <div class="output-section" id="outputSection" style="display: none;">
            <h3>ğŸ“¸ é«˜å“è³ªæˆªå–çµæœ</h3>
            
            <div class="output-stats" id="outputStats"></div>
            
            <div class="download-all">
                <button id="downloadAllButton" class="download-all-button">
                    ğŸ“¥ ä¸‹è¼‰å…¨éƒ¨åœ–ç‰‡ (ZIP)
                </button>
            </div>
            <div class="output-grid" id="outputGrid"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        let videoElement = null;
        let extractedFrames = [];
        let cropData = { x: 0, y: 0, width: 0, height: 0 };
        let isDragging = false;
        let dragType = '';
        let dragStart = { x: 0, y: 0 };

        function toggleAdvanced() {
            const advanced = document.getElementById('advancedSettings');
            advanced.style.display = advanced.style.display === 'none' ? 'block' : 'none';
        }

        // æ¡†æ¶æˆªå–æ¨¡å¼åˆ‡æ›
        function setupCropModeListener() {
            const cropModeSelect = document.getElementById('cropMode');
            if (cropModeSelect) {
                cropModeSelect.addEventListener('change', function() {
                    const cropOverlay = document.getElementById('cropOverlay');
                    const cropControls = document.getElementById('cropControls');
                    
                    if (this.value === 'crop') {
                        if (cropOverlay) cropOverlay.style.display = 'block';
                        if (cropControls) cropControls.style.display = 'block';
                        initializeCropFrame();
                    } else {
                        if (cropOverlay) cropOverlay.style.display = 'none';
                        if (cropControls) cropControls.style.display = 'none';
                    }
                });
            }
        }

        // æª”æ¡ˆé¸æ“‡è™•ç†
        function setupFileInputListener() {
            const fileInput = document.getElementById('videoFile');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const videoContainer = document.getElementById('videoContainer');
                        const videoPreview = document.getElementById('videoPreview');
                        const videoInfo = document.getElementById('videoInfo');
                        const extractButton = document.getElementById('extractButton');
                        
                        const url = URL.createObjectURL(file);
                        videoPreview.src = url;
                        videoElement = videoPreview;
                        
                        videoPreview.addEventListener('loadedmetadata', function() {
                            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                            const duration = this.duration.toFixed(2);
                            const width = this.videoWidth;
                            const height = this.videoHeight;
                            const fps = 30; // ä¼°è¨ˆå€¼
                            
                            videoInfo.innerHTML = `
                                <strong>å½±ç‰‡è³‡è¨Šï¼š</strong><br>
                                ğŸ“ è§£æåº¦: ${width} Ã— ${height} pixels<br>
                                â±ï¸ é•·åº¦: ${duration} ç§’<br>
                                ğŸ“¦ æª”æ¡ˆå¤§å°: ${fileSize} MB<br>
                                ğŸ¬ é ä¼° FPS: ~${fps}
                            `;
                            videoInfo.style.display = 'block';
                            
                            // å¦‚æœæ˜¯æ¡†æ¶æ¨¡å¼ï¼Œåˆå§‹åŒ–æ¡†æ¶
                            const cropMode = document.getElementById('cropMode');
                            if (cropMode && cropMode.value === 'crop') {
                                setTimeout(initializeCropFrame, 100);
                            }
                        });
                        
                        videoContainer.style.display = 'block';
                        extractButton.disabled = false;
                        
                        // é‡ç½®è¼¸å‡ºå€åŸŸ
                        const outputSection = document.getElementById('outputSection');
                        if (outputSection) outputSection.style.display = 'none';
                        extractedFrames = [];
                    }
                });
            }
        }

        function initializeCropFrame() {
            const video = document.getElementById('videoPreview');
            const cropFrame = document.getElementById('cropFrame');
            
            if (video && video.videoWidth) {
                const videoRect = video.getBoundingClientRect();
                const containerRect = video.parentElement.getBoundingClientRect();
                
                // è¨ˆç®—å½±ç‰‡åœ¨å®¹å™¨ä¸­çš„å¯¦éš›ä½ç½®å’Œå¤§å°
                const videoRatio = video.videoWidth / video.videoHeight;
                const containerRatio = videoRect.width / videoRect.height;
                
                let actualVideoWidth, actualVideoHeight, offsetX, offsetY;
                
                if (videoRatio > containerRatio) {
                    // å½±ç‰‡å¯¬åº¦å—é™
                    actualVideoWidth = videoRect.width;
                    actualVideoHeight = videoRect.width / videoRatio;
                    offsetX = 0;
                    offsetY = (videoRect.height - actualVideoHeight) / 2;
                } else {
                    // å½±ç‰‡é«˜åº¦å—é™
                    actualVideoWidth = videoRect.height * videoRatio;
                    actualVideoHeight = videoRect.height;
                    offsetX = (videoRect.width - actualVideoWidth) / 2;
                    offsetY = 0;
                }
                
                // è¨­å®šåˆå§‹æ¡†æ¶å¤§å°ç‚ºå½±ç‰‡çš„ 60%
                const frameWidth = actualVideoWidth * 0.6;
                const frameHeight = actualVideoHeight * 0.6;
                const frameX = offsetX + (actualVideoWidth - frameWidth) / 2;
                const frameY = offsetY + (actualVideoHeight - frameHeight) / 2;
                
                cropFrame.style.left = frameX + 'px';
                cropFrame.style.top = frameY + 'px';
                cropFrame.style.width = frameWidth + 'px';
                cropFrame.style.height = frameHeight + 'px';
                
                updateCropData();
            }
        }

        function updateCropData() {
            const video = document.getElementById('videoPreview');
            const cropFrame = document.getElementById('cropFrame');
            const cropInfo = document.getElementById('cropInfo');
            
            if (!video || !video.videoWidth) return;
            
            const videoRect = video.getBoundingClientRect();
            const frameRect = cropFrame.getBoundingClientRect();
            
            // è¨ˆç®—ç›¸å°æ–¼åŸå§‹å½±ç‰‡çš„åº§æ¨™
            const scaleX = video.videoWidth / videoRect.width;
            const scaleY = video.videoHeight / videoRect.height;
            
            cropData.x = Math.round((frameRect.left - videoRect.left) * scaleX);
            cropData.y = Math.round((frameRect.top - videoRect.top) * scaleY);
            cropData.width = Math.round(frameRect.width * scaleX);
            cropData.height = Math.round(frameRect.height * scaleY);
            
            // ç¢ºä¿æ•¸å€¼åœ¨æœ‰æ•ˆç¯„åœå…§
            cropData.x = Math.max(0, Math.min(cropData.x, video.videoWidth - cropData.width));
            cropData.y = Math.max(0, Math.min(cropData.y, video.videoHeight - cropData.height));
            cropData.width = Math.max(50, Math.min(cropData.width, video.videoWidth - cropData.x));
            cropData.height = Math.max(50, Math.min(cropData.height, video.videoHeight - cropData.y));
            
            cropInfo.textContent = `${cropData.width} Ã— ${cropData.height}`;
        }

        function resetCropFrame() {
            initializeCropFrame();
        }

        function centerCropFrame() {
            const video = document.getElementById('videoPreview');
            const cropFrame = document.getElementById('cropFrame');
            
            if (video && video.videoWidth) {
                const videoRect = video.getBoundingClientRect();
                const frameRect = cropFrame.getBoundingClientRect();
                
                const centerX = videoRect.left + (videoRect.width - frameRect.width) / 2;
                const centerY = videoRect.top + (videoRect.height - frameRect.height) / 2;
                
                cropFrame.style.left = (centerX - videoRect.left) + 'px';
                cropFrame.style.top = (centerY - videoRect.top) + 'px';
                
                updateCropData();
            }
        }

        function toggleCropPreview() {
            // é€™è£¡å¯ä»¥å¯¦ä½œé è¦½åŠŸèƒ½
            alert('é è¦½åŠŸèƒ½ï¼šå°‡é¡¯ç¤ºç•¶å‰æ¡†æ¶é¸å–çš„å€åŸŸæ•ˆæœ');
        }

        // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        function initializeDragHandlers() {
            // æ‹–æ‹½åŠŸèƒ½
            document.addEventListener('mousedown', function(e) {
                const cropFrame = document.getElementById('cropFrame');
                if (!cropFrame || !cropFrame.contains(e.target)) return;
                
                isDragging = true;
                dragStart.x = e.clientX;
                dragStart.y = e.clientY;
                
                if (e.target.classList.contains('crop-handle')) {
                    dragType = 'resize-' + e.target.classList[1];
                } else {
                    dragType = 'move';
                }
                
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const cropFrame = document.getElementById('cropFrame');
                if (!cropFrame) return;
                
                const deltaX = e.clientX - dragStart.x;
                const deltaY = e.clientY - dragStart.y;
                
                if (dragType === 'move') {
                    const currentLeft = parseInt(cropFrame.style.left) || 0;
                    const currentTop = parseInt(cropFrame.style.top) || 0;
                    cropFrame.style.left = (currentLeft + deltaX) + 'px';
                    cropFrame.style.top = (currentTop + deltaY) + 'px';
                } else if (dragType.startsWith('resize-')) {
                    const currentWidth = parseInt(cropFrame.style.width) || 100;
                    const currentHeight = parseInt(cropFrame.style.height) || 100;
                    const currentLeft = parseInt(cropFrame.style.left) || 0;
                    const currentTop = parseInt(cropFrame.style.top) || 0;
                    
                    switch (dragType) {
                        case 'resize-se':
                            cropFrame.style.width = Math.max(50, currentWidth + deltaX) + 'px';
                            cropFrame.style.height = Math.max(50, currentHeight + deltaY) + 'px';
                            break;
                        case 'resize-sw':
                            cropFrame.style.width = Math.max(50, currentWidth - deltaX) + 'px';
                            cropFrame.style.height = Math.max(50, currentHeight + deltaY) + 'px';
                            cropFrame.style.left = (currentLeft + deltaX) + 'px';
                            break;
                        case 'resize-ne':
                            cropFrame.style.width = Math.max(50, currentWidth + deltaX) + 'px';
                            cropFrame.style.height = Math.max(50, currentHeight - deltaY) + 'px';
                            cropFrame.style.top = (currentTop + deltaY) + 'px';
                            break;
                        case 'resize-nw':
                            cropFrame.style.width = Math.max(50, currentWidth - deltaX) + 'px';
                            cropFrame.style.height = Math.max(50, currentHeight - deltaY) + 'px';
                            cropFrame.style.left = (currentLeft + deltaX) + 'px';
                            cropFrame.style.top = (currentTop + deltaY) + 'px';
                            break;
                    }
                }
                
                dragStart.x = e.clientX;
                dragStart.y = e.clientY;
                updateCropData();
                e.preventDefault();
            });

            document.addEventListener('mouseup', function(e) {
                isDragging = false;
                dragType = '';
            });
        }

        // ç•¶é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeDragHandlers();
            setupCropModeListener();
            setupFileInputListener();
            
            // è¨­ç½®æˆªå–æŒ‰éˆ•ç›£è½å™¨
            const extractButton = document.getElementById('extractButton');
            if (extractButton) {
                extractButton.addEventListener('click', handleExtractFrames);
            }
            
            // è¨­ç½®ä¸‹è¼‰å…¨éƒ¨æŒ‰éˆ•ç›£è½å™¨
            const downloadAllButton = document.getElementById('downloadAllButton');
            if (downloadAllButton) {
                downloadAllButton.addEventListener('click', handleDownloadAll);
            }
        });

        // æª”æ¡ˆé¸æ“‡è™•ç† - ç§»é™¤åŸä¾†çš„ç›£è½å™¨è¨­ç½®

        // æ‡‰ç”¨é€²éšå½±åƒè™•ç†
        function applyImageEnhancements(canvas, ctx) {
            const sharpening = parseFloat(document.getElementById('sharpening').value);
            const contrast = parseFloat(document.getElementById('contrast').value);
            const saturation = parseFloat(document.getElementById('saturation').value);
            
            if (sharpening > 0 || contrast !== 1 || saturation !== 1) {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // å°æ¯”åº¦å’Œé£½å’Œåº¦èª¿æ•´
                for (let i = 0; i < data.length; i += 4) {
                    // å°æ¯”åº¦èª¿æ•´
                    data[i] = Math.min(255, Math.max(0, (data[i] - 128) * contrast + 128));
                    data[i + 1] = Math.min(255, Math.max(0, (data[i + 1] - 128) * contrast + 128));
                    data[i + 2] = Math.min(255, Math.max(0, (data[i + 2] - 128) * contrast + 128));
                    
                    // é£½å’Œåº¦èª¿æ•´
                    if (saturation !== 1) {
                        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                        data[i] = Math.min(255, Math.max(0, gray + saturation * (data[i] - gray)));
                        data[i + 1] = Math.min(255, Math.max(0, gray + saturation * (data[i + 1] - gray)));
                        data[i + 2] = Math.min(255, Math.max(0, gray + saturation * (data[i + 2] - gray)));
                    }
                }
                
                // éŠ³åŒ–è™•ç†
                if (sharpening > 0) {
                    const sharpenedData = applySharpenFilter(data, canvas.width, canvas.height, sharpening);
                    for (let i = 0; i < data.length; i++) {
                        data[i] = sharpenedData[i];
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
            }
        }

        function applySharpenFilter(data, width, height, intensity) {
            const result = new Uint8ClampedArray(data);
            const kernel = [
                0, -intensity, 0,
                -intensity, 1 + 4 * intensity, -intensity,
                0, -intensity, 0
            ];
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        let sum = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                                sum += data[idx] * kernel[(ky + 1) * 3 + (kx + 1)];
                            }
                        }
                        const idx = (y * width + x) * 4 + c;
                        result[idx] = Math.min(255, Math.max(0, sum));
                    }
                }
            }
            return result;
        }

        // æˆªå–ç•«é¢åŠŸèƒ½
        async function handleExtractFrames() {
            if (!videoElement) return;
            
            const interval = parseFloat(document.getElementById('interval').value);
            const quality = parseFloat(document.getElementById('quality').value);
            const format = document.getElementById('format').value;
            const smoothing = document.getElementById('smoothing').value === 'true';
            
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const outputSection = document.getElementById('outputSection');
            const outputGrid = document.getElementById('outputGrid');
            const outputStats = document.getElementById('outputStats');
            
            // é¡¯ç¤ºé€²åº¦æ¢
            progressContainer.style.display = 'block';
            
            const currentExtractButton = document.getElementById('extractButton');
            if (currentExtractButton) {
                currentExtractButton.disabled = true;
                currentExtractButton.textContent = 'â³ è™•ç†ä¸­...';
            }
            
            // æ¸…ç©ºä¹‹å‰çš„çµæœ
            outputGrid.innerHTML = '';
            extractedFrames = [];
            
            const duration = videoElement.duration;
            const totalFrames = Math.floor(duration / interval) + 1;
            let currentFrame = 0;
            let totalSize = 0;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // ç­‰å¾…å½±ç‰‡è¼‰å…¥å®Œæˆ
            await new Promise(resolve => {
                if (videoElement.readyState >= 2) {
                    resolve();
                } else {
                    videoElement.addEventListener('loadeddata', resolve);
                }
            });
            
            // è¨­å®šé«˜å“è³ª canvas
            const cropMode = document.getElementById('cropMode').value;
            
            if (cropMode === 'crop' && cropData.width > 0 && cropData.height > 0) {
                canvas.width = cropData.width;
                canvas.height = cropData.height;
            } else {
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
            }
            
            ctx.imageSmoothingEnabled = smoothing;
            if (!smoothing) {
                ctx.imageSmoothingQuality = 'high';
            }
            
            const startTime = Date.now();
            
            for (let time = 0; time <= duration; time += interval) {
                try {
                    // è¨­å®šå½±ç‰‡æ™‚é–“ä¸¦ç­‰å¾…è·³è½‰å®Œæˆ
                    const targetTime = Math.min(time, duration);
                    
                    // å¦‚æœæ™‚é–“å·®ç•°å¾ˆå°ï¼Œä¸éœ€è¦è·³è½‰
                    if (Math.abs(videoElement.currentTime - targetTime) > 0.1) {
                        await new Promise(resolve => {
                            let resolved = false;
                            
                            const seekHandler = () => {
                                if (!resolved) {
                                    resolved = true;
                                    videoElement.removeEventListener('seeked', seekHandler);
                                    // é¡å¤–ç­‰å¾…ç¢ºä¿ç•«é¢æ›´æ–°
                                    setTimeout(resolve, 50);
                                }
                            };
                            
                            // è¨­å®šè¶…æ™‚é¿å…å¡ä½
                            const timeout = setTimeout(() => {
                                if (!resolved) {
                                    resolved = true;
                                    videoElement.removeEventListener('seeked', seekHandler);
                                    resolve();
                                }
                            }, 1000);
                            
                            videoElement.addEventListener('seeked', seekHandler);
                            videoElement.currentTime = targetTime;
                        });
                    }
                    
                    // å†æ¬¡ç¢ºèªæ™‚é–“è¨­å®šæ­£ç¢º
                    if (Math.abs(videoElement.currentTime - targetTime) > 0.2) {
                        console.warn(`æ™‚é–“è·³è½‰ä¸æº–ç¢º: ç›®æ¨™ ${targetTime}s, å¯¦éš› ${videoElement.currentTime}s`);
                    }
                    
                    // ç¹ªè£½åˆ° canvas
                    const cropMode = document.getElementById('cropMode').value;
                    
                    if (cropMode === 'crop' && cropData.width > 0 && cropData.height > 0) {
                        // æ¡†æ¶æˆªå–æ¨¡å¼
                        canvas.width = cropData.width;
                        canvas.height = cropData.height;
                        ctx.drawImage(
                            videoElement, 
                            cropData.x, cropData.y, cropData.width, cropData.height,
                            0, 0, cropData.width, cropData.height
                        );
                    } else {
                        // å®Œæ•´ç•«é¢æ¨¡å¼
                        canvas.width = videoElement.videoWidth;
                        canvas.height = videoElement.videoHeight;
                        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    }
                    
                    // æ‡‰ç”¨é€²éšå½±åƒè™•ç†
                    applyImageEnhancements(canvas, ctx);
                    
                    // è½‰æ›ç‚ºåœ–ç‰‡ï¼Œæ·»åŠ æ™‚é–“æˆ³è¨˜åˆ°æª”å
                    const dataURL = canvas.toDataURL(format, quality);
                    const timestamp = Math.floor(time * 10) / 10;
                    const filename = `frame_${timestamp.toFixed(1)}s_${Date.now()}.${getFileExtension(format)}`;
                    
                    // è¨ˆç®—æª”æ¡ˆå¤§å°
                    const base64Data = dataURL.split(',')[1];
                    const sizeInBytes = base64Data.length * 0.75;
                    totalSize += sizeInBytes;
                    
                    extractedFrames.push({
                        dataURL: dataURL,
                        timestamp: timestamp,
                        filename: filename,
                        size: sizeInBytes
                    });
                    
                    // å‰µå»ºé è¦½
                    createPreviewItem(dataURL, timestamp, format, sizeInBytes);
                    
                    // æ›´æ–°é€²åº¦
                    currentFrame++;
                    const progress = (currentFrame / totalFrames) * 100;
                    progressFill.style.width = progress + '%';
                    progressText.textContent = `é«˜å“è³ªè™•ç†ä¸­ ${currentFrame} / ${totalFrames} å¼µ... (${timestamp.toFixed(1)}s)`;
                    
                    // æ·»åŠ å°å»¶é²ç¢ºä¿ç€è¦½å™¨æœ‰æ™‚é–“æ›´æ–° UI
                    await new Promise(resolve => setTimeout(resolve, 10));
                    
                } catch (error) {
                    console.error('æˆªå–ç•«é¢æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                }
            }
            
            const processingTime = ((Date.now() - startTime) / 1000).toFixed(1);
            const avgSize = (totalSize / extractedFrames.length / 1024).toFixed(1);
            const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
            
            // é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
            outputStats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${extractedFrames.length}</div>
                    <div class="stat-label">å¼µåœ–ç‰‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${totalSizeMB} MB</div>
                    <div class="stat-label">ç¸½å¤§å°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${avgSize} KB</div>
                    <div class="stat-label">å¹³å‡å¤§å°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${processingTime}s</div>
                    <div class="stat-label">è™•ç†æ™‚é–“</div>
                </div>
            `;
            
            // å®Œæˆ
            progressText.textContent = `ğŸ”¥ é«˜å“è³ªæˆªå–å®Œæˆï¼å…±ç”¢ç”Ÿ ${extractedFrames.length} å¼µåœ–ç‰‡`;
            outputSection.style.display = 'block';
            
            const finalExtractButton = document.getElementById('extractButton');
            if (finalExtractButton) {
                finalExtractButton.disabled = false;
                finalExtractButton.textContent = 'ğŸ¯ é–‹å§‹é«˜å“è³ªæˆªå–';
            }
        }

        function getFileExtension(mimeType) {
            switch (mimeType) {
                case 'image/png': return 'png';
                case 'image/webp': return 'webp';
                default: return 'jpg';
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes.toFixed(0) + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function createPreviewItem(dataURL, timestamp, format, size) {
            const outputGrid = document.getElementById('outputGrid');
            const item = document.createElement('div');
            item.className = 'output-item';
            
            item.innerHTML = `
                <img src="${dataURL}" alt="Frame at ${timestamp}s">
                <div class="frame-info">
                    <span>â±ï¸ ${timestamp.toFixed(1)}s</span>
                    <span>ğŸ“¦ ${formatFileSize(size)}</span>
                </div>
                <a href="${dataURL}" download="frame_${timestamp.toFixed(1)}s.${getFileExtension(format)}" class="download-link">
                    ğŸ“¥ ä¸‹è¼‰é«˜å“è³ªåœ–ç‰‡
                </a>
            `;
            
            outputGrid.appendChild(item);
        }

        // ä¸‹è¼‰å…¨éƒ¨åœ–ç‰‡ç‚º ZIP
        async function handleDownloadAll() {
            if (extractedFrames.length === 0) return;
            
            const downloadButton = document.getElementById('downloadAllButton');
            if (!downloadButton) return;
            
            downloadButton.disabled = true;
            downloadButton.textContent = 'ğŸ“¦ æ­£åœ¨æ‰“åŒ…é«˜å“è³ªåœ–ç‰‡...';
            
            const zip = new JSZip();
            
            for (const frame of extractedFrames) {
                // å°‡ data URL è½‰æ›ç‚º blob
                const response = await fetch(frame.dataURL);
                const blob = await response.blob();
                zip.file(frame.filename, blob);
            }
            
            // ç”Ÿæˆ ZIP æª”æ¡ˆ
            const zipBlob = await zip.generateAsync({
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 1 } // æœ€å°å£“ç¸®ä»¥ä¿æŒå“è³ª
            });
            
            // ä¸‹è¼‰
            const link = document.createElement('a');
            link.href = URL.createObjectURL(zipBlob);
            link.download = `ultra_hd_frames_${new Date().getTime()}.zip`;
            link.click();
            
            downloadButton.disabled = false;
            downloadButton.textContent = 'ğŸ“¥ ä¸‹è¼‰å…¨éƒ¨åœ–ç‰‡ (ZIP)';
        }
    </script>
</body>
</html>